# Detecting disease associated pathways by whole-genome sequencing data 
The analysis process mainly includes 6 steps and depending on python or R. As follows, we provide a complete and concise procedure code along with explanations, facilitating researchers to conduct personalized analyses. Copy the code to your script as according to your needs and make the necessary modifications as prompted (e.g., if your genome sequencing data does not require processing, you may ignore the first step. Alternatively, if you adopt an HHG P value < 0.001 as the threshold for significant association between pathways and disease risk, you may skip the permutation calculation in step 5.6).

## Step 1. WGS —> Genotype
In order to perform polygenic risk score (PRS) analysis and gene expression prediction, whole genome sequencing data in the format of .bed, .bim, .fam is required.

Here's an outline of the processing whole-genome sequencing (WGS) raw sequencing data into .bed, .bim, and .fam formats

### 1.1	Software and reference genome sequence preparation
Download and install the following software: BWA, Samtools, GATK4.0, fastp, plink.

Download the reference genome sequence (for example: GRCh38.fa).

### 1.2	Quality control (QC) of raw sequencing data
QC and remove sequencing adapters and low-quality sequences.

Example code
```
fastp -i Sample1_1.fastq.gz -o Sample1_1.clean.fastq.gz -I Sample1_2.fastq.gz -O Sample1_2.clean.fastq.gz -f 5 -t 5 -F 5 -T 5 -5 -W 5 -M 20 -Q -l 50 -c -w 4
```
- -i: the input file name of read1. -o: the output file name of read1. -I: the input file name of read2. -O: the output file name of read2. -f 5 -t 5 -F 5 -T 5: global trimming options. Trim low-quality base number parameters at the beginning and end of the sequence. -5 -W 5 -M 20: per read cutting by quality options. -Q: --disable_quality_filtering. -l, --length_required. -c, --correction. -w, --thread.

### 1.3	Alignment
Index preparation and alignment by BWA. Format conversion by Samtools.

Example code
```
bwa index GRCh38.fa
bwa mem -t 4 GRCh38.fa Sample1_1.clean.fastq.gz Sample1_2.clean.fastq.gz | samtools view -Sb - > Sample1.bam
```
- Usage: bwa mem [options] <idxbase> <in1.fq> [in2.fq]. -t: number of threads. samtools: converted to BAM format

### 1.4	Variant Calling
Example code
```
gatk HaplotypeCaller -R GRCh38.fa -I Sample1.bam -O Sample1.variants.vcf
```

### 1.5	Combining variants from different files into one
When you have been using HaplotypeCaller to call variants on a large cohort, producing many gVCF files. It is recommend that combining the output gVCF in batches of e.g. 200 before putting them through joint genotyping with GenotypeGVCFs (for performance reasons), which you can do using CombineGVCFs, which is specific for handling gVCF files.

Example code
```
gatk CombineGVCFs -R GRCh38.fa --variant Sample1.vcf --variant Sample2.vcf -O cohort.vcf.gz
gatk GenotypeGVCFs -R GRCh38.fa -V cohort.vcf.gz -O genotype.data.vcf
```

### 1.6	Format conversion
convert the vcf format to .bed, .bim, and .fam format
```
plink --vcf genotype.data.vcf --make-bed --out genotype.data
```
Finally, .bed, .bim, and .fam files with the prefix of genotype.data (can be modified, if modified, please note that the same modifications need to be made during subsequent analysis) will be generated. These files will be used as input files for subsequent analysis.

## Step 2. Genotype —> Polygenic risk score, PRS
Disease risk score analysis for each individual. Genome-wide association analysis (GWAS) of disease and whole-genome sequencing data generated by first-step are required. For data format, please refer to the sample data provided at https://choishingwan.github.io/PRS-Tutorial/.

### 2.1	QC of Base Data
Quality Control (QC) of GWAS data. Please refer to the process at https://choishingwan.github.io/PRS-Tutorial/. The QCed GWAS data files can be used for downstream analysis.

### 2.2	PRScs analysis
Calculate the disease risk scores for each individual. For detailed parameter description, please refer to https://github.com/getian107/PRScs.

Usage example
```
python PRScs.py --ref_dir=PATH_TO_REFERENCE --bim_prefix=VALIDATION_BIM_PREFIX --sst_file=SUM_STATS_FILE --n_gwas=GWAS_SAMPLE_SIZE --out_dir=OUTPUT_DIR [--a=PARAM_A --b=PARAM_B --phi=PARAM_PHI --n_iter=MCMC_ITERATIONS --n_burnin=MCMC_BURNIN --thin=MCMC_THINNING_FACTOR --chrom=CHROM --beta_std=BETA_STD --seed=SEED]
```
Result files in txt format will be generated in the OUTPUT_DIR directory, differentiated by chromosome. After the PRScs calculation of all chromosomes is completed, the PRScs results of all chromosomes need to be combined. The plink can be used to calculate the individual disease risk score.

Example code
```
cd OUTPUT_DIR
cat *.txt > PRScs.result
plink --bfile genotype.data --score OUTPUT_DIR/PRScs.result 2 4 6 header sum --out OUTPUT_DIR/PRScs.final.result
```
A result file containing 6 columns (FID, IID, PHENO, CNT, CNT2, SCORESUM) named PRScs.final.result.profile (the file name prefix can be modified. If modified, please note that the same modifications need to be made during subsequent analysis) will be generated. This file will be used for the calculations in step 5.

## Step 4. gene expression —> ssGSVA
Pathway enrichment analysis for each individual. The gene expression profile predicted in the previous step and the gene sets of pathways are required. For the ssGSVA analysis, we have integrated gene sets of 1,649,335 human pathways from multiple databases, including GSEA (MSigDB v7.5.1, URL: https://www.gsea-msigdb.org/gsea/index.jsp), DAVID (v.2022q2, URL: https://david.ncifcrf.gov/), Reactome (v81, URL: https://reactome.org/), NetPath (URL: http://netpath.org/), PANTHER (URL: http://www.pantherdb.org/), WikiPathways (v.20220710, URL: https://classic.wikipathways.org/index.php/), and PathBank (URL: https://pathbank.org/). All gene names or gene IDs were transformed to ensemble gene IDs. Meanwhile, the pathway names were organized in the format of type~ID~term, for example, GOBP~GO:0000002~mitochondrial genome maintenance. Some pathways were in type~term format since they do not have IDs. In addition, the same pathway in different databases was subject to the newer version. The integrated data can be downloaded here in Rdata format (**geneSets.Rdata**).

Please use R software to perform this step. Please install dependent R packages GSVA, psych, HHG, doParallel, etc. in advance. The codes and annotations please refer to the R script **pipeline.ssGSVA.and.correlation.R**.

## Step 5. Association between disease risk (PRS) and pathways (GSVA)
Analysis of pathways significantly associated with disease risk. This step is connected to the previous part, please continue to use R software.

Since most ssGSVA scores did not follow a normal distribution (Shapiro-Wilk test p < 0.05), and the correlation pattern between ssGSVA score and disease risk scores was unknown, we employed the HHG method to assess the correlation. If the number of pathways is large, it is recommended to use parallel computing. Please refer to the R package doParallel. It is worth noting that the significant correlation pathways identified by HHG (P < 0.001) aligned with those identified by the permutation procedure. Therefore, if you use HHG P value < 0.001 as the threshold for a pathway to be significantly associated with disease risk, you can ignore the permutation calculation in step 5.6. If using permutation procedure to calculate, please ignore step 5.5. And since the recommended number of calculations for each permutation procedure is 1,000 to10,000 times, which takes a long time, please use parallel computing to produce results as quickly as possible. It is necessary to check whether the parallel computing results are complete, that is, to check whether all pathways have produced permutation results. This is because the calculation process undertaken by some cores may fail, but the program can still continue to run and produce uncomplete results.

The codes and annotations please refer to the R script **pipeline.ssGSVA.and.correlation.R**.



